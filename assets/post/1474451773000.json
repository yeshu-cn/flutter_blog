{"title":"DownlaodManager note","createTime":1474451773000,"updateTime":-1,"category":"default","content":" \n  \n ###### android 5.1.1 (22)，Honor:CHM-TL00H:手机上系统数据库缺少字段造成下载失败 \n  \n ``` \n java.lang.NullPointerException: Attempt to invoke virtual method 'java.lang.String android.net.Uri.getLastPathSegment()' on a null object reference \n \tat android.app.DownloadManager.enqueue(DownloadManager.java:950) \n ``` \n  \n ###### DownloadManager disable造成下载失败 \n  \n 禁用／开启DownloadManager方法：设置－>引用程序->下载管理器－>Enable/Disable \n  \n ``` \n java.lang.IllegalArgumentException: Unknown URL content://downloads/my_downloads \n ``` \n  \n ###### 源码分析 \n  \n ```java \n \t//ContentResolver.java文件中 \n     public final @Nullable Uri insert(@NonNull Uri url, @Nullable ContentValues values) { \n         Preconditions.checkNotNull(url, \"url\"); \n         IContentProvider provider = acquireProvider(url); \n         if (provider == null) { \n         \t\t//DownloadManager disable造成下载失败 \n             throw new IllegalArgumentException(\"Unknown URL \" + url); \n         } \n         try { \n             long startTime = SystemClock.uptimeMillis(); \n             //insert时数据库该手机上数据库缺少个字段造成return null \n             Uri createdRow = provider.insert(mPackageName, url, values); \n             long durationMillis = SystemClock.uptimeMillis() - startTime; \n             maybeLogUpdateToEventLog(durationMillis, url, \"insert\", null /* where */); \n             return createdRow; \n         } catch (RemoteException e) { \n             // Arbitrary and not worth documenting, as Activity \n             // Manager will kill this process shortly anyway. \n             return null; \n         } finally { \n             releaseProvider(provider); \n         } \n     } \n ``` \n  \n ###### 需先判断DownloadManager是否可用，在进行下载 \n  \n 参考Gmail inbox做法,下载前检测DownloadManager是否可用，如果不可用提示用户DownloadManager is disabled. Please enable it.  \n  \n [how to enable android download manager ](http://stackoverflow.com/questions/21551538/how-to-enable-android-download-manager) \n  \n ```java \n private static boolean isEnableDownloadManager(Context context) { \n         ApplicationInfo ai = null; \n         try { \n             ai = context.getPackageManager().getApplicationInfo(\"com.android.providers.downloads\", 0); \n         } catch (PackageManager.NameNotFoundException e) { \n             return false; \n         } \n  \n         return ai.enabled; \n     } \n ``` \n  \n ###### Url不合法会崩溃,需要检查Url \n  \n ```java \n Uri resource = Uri.parse(apkPath); \n DownloadManager.Request request; \n //url不合法会崩溃 \n request = new DownloadManager.Request(resource); \n ``` \n  \n 使用`URLUtil.isValidUrl(url)`来判断url是否合法（`www.qq.com`这种是不合法的，必需有`http://`等） \n  \n [check url is valid](http://stackoverflow.com/questions/4905075/how-to-check-if-url-is-valid-in-android) \n  \n  \n ###### try catch 会不会影响性能 \n  \n 在不抛出异常等情况下，不会影响性能。try catch范围等大小也不会影响性能，只是影响代码可读性。"}